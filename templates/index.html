<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>LabCam Profiler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="layout">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-inner">
        <h1 class="app-title">LabCam Profiler</h1>

        <section class="panel">
          <h2>Camera</h2>
          <label class="row space">
            <span>Camera</span>
            <select id="cameraSelect" style="flex-grow: 1;"></select>
          </label>
          <label class="row space">
            <span>Enabled</span>
            <input id="cameraToggle" type="checkbox" />
          </label>
        <div class="row space background-controls">
          <label class="row background-toggle">
            <span>Background Subtraction</span>
            <input id="backgroundSubtractionToggle" type="checkbox" />
          </label>
          <button id="autoExposureBtn" class="secondary" type="button" title="Auto adjust exposure to avoid saturation">Auto exposure</button>
        </div>
      </section>

      <section class="panel">
        <h2>Data Export</h2>
        <button id="saveAllBtn" class="primary">Save All</button>
      </section>

        <section class="panel">
          <h2>Exposure (µs)</h2>
          <div class="row space">
            <input id="expSlider" type="range" min="1000" max="50000" step="1000" />
            <span id="expLabel" class="mono">-</span>
          </div>
        </section>

        <section class="panel">
          <h2>Colormap</h2>
          <select id="colormapSelect">
            <option value="grey">grey</option>
            <option value="jet">jet</option>
            <option value="cubiczero">cubiczero</option>
          </select>
        </section>

        <section class="panel">
          <h2>Beam Analysis</h2>
          <label class="row space">
            <span>Pixel size (m)</span>
            <input id="baPixelSize" type="number" step="any" placeholder="e.g. 3.45e-6" style="width:120px;" />
          </label>
          <label class="row space">
            <span>Compute</span>
            <select id="baCompute" style="flex-grow:1;">
              <option value="both">both</option>
              <option value="second">second</option>
              <option value="gauss">gauss</option>
              <option value="none">none</option>
            </select>
          </label>
          <label class="row space">
            <span>Clip negatives</span>
            <select id="baClipNegatives" style="flex-grow:1;">
              <option value="none">none</option>
              <option value="zero">zero</option>
              <option value="otsu">otsu</option>
            </select>
          </label>
          <label class="row space">
            <span>Angle clip mode</span>
            <select id="baAngleClip" style="flex-grow:1;">
              <option value="same">same</option>
              <option value="none">none</option>
              <option value="zero">zero</option>
              <option value="otsu">otsu</option>
            </select>
          </label>
          <label class="row space">
            <span>Background subtraction</span>
            <input id="baBackground" type="checkbox" />
          </label>
          <label class="row space">
            <span>Rotation</span>
            <select id="baRotation" style="flex-grow:1;">
              <option value="auto">auto</option>
              <option value="fixed">fixed</option>
            </select>
          </label>
          <label class="row space">
            <span>Fixed angle (deg)</span>
            <input id="baFixedAngle" type="number" step="any" placeholder="0.0" style="width:120px;" />
          </label>
        </section>

        <section id="causticPanel" class="panel collapsible">
          <div class="collapsible-header">
            <h2>Caustic</h2>
            <button id="causticCollapseBtn" class="collapse-toggle" aria-label="Toggle Caustic section"></button>
          </div>
          <div class="collapsible-body">
            <label class="row space">
              <span>Wavelength (nm)</span>
              <input id="causticWavelength" type="number" step="any" placeholder="1030" />
            </label>
            <label class="row space">
              <span>Position unit</span>
              <input id="causticUnit" type="text" placeholder="mm" />
            </label>
            <label class="row space">
              <span>Radii source</span>
              <select id="causticSource">
                <option value="gauss_1e2">Gaussian 1/e² radii (x, y)</option>
                <option value="moment_2sigma">2σ second-moment radii (x, y)</option>
              </select>
            </label>
            <div class="row caustic-actions">
              <button id="causticLoadBtn" class="secondary">Load images...</button>
              <button id="causticFitBtn" class="primary">M² fit</button>
            </div>
            <div class="caustic-point-header">
              <span class="roi">ROI</span>
              <span class="z">z</span>
              <span class="wx">wx</span>
              <span class="wy">wy</span>
              <span class="src">source</span>
              <span class="remove"></span>
            </div>
            <div id="causticPointList" class="caustic-point-list"></div>
          </div>
        </section>

        <section class="panel">
          <h2>ROIs</h2>
          <div id="roiHint" class="hint">Add by dragging on the live view. Drag to move. Resize using handles.</div>
          <div id="roiList" class="roi-list"></div>
        </section>
      </div>
    </aside>

    <!-- Right Workspace -->
    <main class="workspace">
      <!-- Live View -->
      <section class="work-panel">
        <div class="panel-header">
          <h2>Live View</h2>
          <div class="stats mono">
            <span id="statsExposure">exp: -</span>
            <span id="statsFps">fps: -</span>
            <span id="statsMaxPixel">peak: -</span>
          </div>
        </div>
        <div id="liveContainer" class="live-container">
          <img id="stream" alt="Stream" src="/video_feed" />
          <canvas id="roiOverlay"></canvas>
        </div>
      </section>


      <!-- ROI Streams Grid -->
      <section id="roiGridPanel" class="work-panel" hidden>
        <div class="panel-header">
          <h2>ROI Streams</h2>
        </div>
        <div id="roiGrid" class="roi-grid"></div>
      </section>

      <!-- Per-ROI Panels -->
      <section id="perRoiPanels" class="work-panel" hidden>
        <div class="panel-header">
          <h2>Per-ROI Panels</h2>
        </div>
        <div id="perRoiGrid" class="per-roi-grid">
          <!-- JS will populate this -->
        </div>
      </section>

      <section id="causticImagesSection" class="work-panel" hidden>
        <div class="panel-header">
          <h2>Caustic Images</h2>
        </div>
        <div id="causticImagesGrid" class="caustic-images-grid"></div>
      </section>

      <section id="causticPlotSection" class="work-panel" hidden>
        <div class="panel-header">
          <h2>Caustic Plot</h2>
        </div>
        <div class="caustic-plot-wrapper">
          <canvas id="causticPlotCanvas"></canvas>
          <div id="causticPlotEmpty" class="caustic-empty" hidden>No caustic data collected yet.</div>
        </div>
        <div class="caustic-plot-actions">
          <button id="causticSaveBtn" class="secondary">Save caustic</button>
        </div>
        <div id="causticFitSummary" class="caustic-fit-summary"></div>
      </section>
    </main>
  </div>

  <script defer src="{{ url_for('static', filename='app.js') }}"></script>

  <div id="causticAddModal" class="modal" hidden>
    <div class="modal-content">
      <span id="causticModalClose" class="close-button">&times;</span>
      <h2>Add Point to Caustic</h2>
      <p>Capture radii and imagery for this ROI at the specified z-position.</p>
      <div class="modal-row">
        <span class="label">ROI</span>
        <span id="causticModalRoi" class="value">-</span>
      </div>
      <label class="modal-label">
        <span>Z-position (<span id="causticModalUnit">mm</span>)</span>
        <input type="number" id="causticModalZ" step="any" />
      </label>
      <div class="modal-actions">
        <button id="causticModalCancel" class="secondary">Cancel</button>
        <button id="causticModalAdd" class="primary">Add</button>
      </div>
    </div>
  </div>

  <div id="causticImportModal" class="modal" hidden>
    <div class="modal-content small">
      <span id="causticImportClose" class="close-button">&times;</span>
      <h2>Import Caustic Images</h2>
      <p>Choose previously saved BMP frames to add to the current dataset.</p>
      <div class="modal-radio">
        <input type="radio" name="causticImportMode" id="causticImportModeUpload" value="upload" checked />
        <span>Upload from this computer</span>
      </div>
      <div class="modal-radio">
        <input type="radio" name="causticImportMode" id="causticImportModeServer" value="server" />
        <span>Use a server-side folder</span>
      </div>
      <div id="causticImportUploadGroup" class="modal-section">
        <label class="modal-label">
          <span>Select BMP files</span>
          <input type="file" id="causticImportFiles" accept=".bmp,.BMP" multiple />
        </label>
      </div>
      <div id="causticImportServerGroup" class="modal-section" hidden>
        <label class="modal-label">
          <span>Folder path (server-side)</span>
          <input type="text" id="causticImportFolder" placeholder="C:\data\caustic" />
        </label>
        <label class="modal-checkbox">
          <input type="checkbox" id="causticImportRecursive" />
          <span>Scan recursively</span>
        </label>
      </div>
      <div id="causticImportProgress" class="import-progress" hidden>
        <div class="progress-track">
          <div class="progress-fill"></div>
        </div>
        <div class="progress-meta">
          <span id="causticImportProgressText">Waiting...</span>
        </div>
      </div>
      <div class="modal-actions">
        <button id="causticImportCancel" class="secondary">Cancel</button>
        <button id="causticImportConfirm" class="primary">Import</button>
      </div>
    </div>
  </div>
  <div id="backgroundSubtractionModal" class="modal" hidden>
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Background Subtraction</h2>
      <p>Please block the beam to capture the background. The application will capture a number of frames and average them to create a background image that will be subtracted from all subsequent frames.</p>
      <label for="numFrames">Number of frames to average:</label>
      <input type="number" id="numFrames" name="numFrames" value="10" min="1">
      <button id="startBgSubtraction" class="primary">Start</button>
    </div>
  </div>
  <div id="toastContainer" class="toast-container"></div>
</body>
</html>



